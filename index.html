<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Zarcom Cameras Map</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    html, body { margin: 0; padding: 0; height: 100%; width: 100%; }
    #map { height: 100%; width: 100%; }
    .top-bar {
      position: absolute; top: 10px; left: 10px; right: 10px; z-index: 1100;
      display: flex; align-items: center; gap: 6px;
      background: white; padding: 10px; border-radius: 12px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
    }
    .top-bar input { flex: 1; padding: 8px 12px; font-size: 14px; border-radius: 20px; border: 1px solid #ccc; }
    .top-bar button { padding: 6px 12px; border: none; border-radius: 16px; background: #eee; cursor: pointer; font-size: 14px; }
    .top-bar button.active { background: #ddd; }
    #controls { position: absolute; bottom: 20px; right: 20px; z-index: 1000; display: flex; flex-direction: column; gap: 8px; }
    #controls button { width: 40px; height: 40px; background: white; border-radius: 50%; border: 1px solid rgba(0,0,0,0.2); box-shadow: 0 2px 4px rgba(0,0,0,0.2); font-size: 20px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: background-color 0.3s; }
    #controls button:hover { background: #f1f1f1; }

    /* List View */
    #cameraListView { display: none; position: absolute; top: 60px; bottom: 0; left: 0; right: 0; background: white; overflow-y: auto; z-index: 1000; padding: 10px; }
    #cameraListAlphabetical { list-style: none; padding: 0; margin: 0; }
    #cameraListAlphabetical li { text-align: center; margin-bottom: 24px; }
    #cameraListAlphabetical .title { font-weight: bold; cursor: pointer; margin-bottom: 8px; font-size: 16px; }
    #cameraListAlphabetical .video-container { display: none; width: 50%; max-width: 400px; aspect-ratio: 16 / 9; margin: 0 auto 16px; background: #000; }
    #cameraListAlphabetical video { width: 100%; height: 100%; object-fit: cover; }

        /* Mobile adjustments */
    @media (max-width: 600px) {
      /* Hide filter icons and map toggle on small screens */
      .filter-btn,
      #toggleMapBtn {
        display: none;
      }
      /* Ensure list toggle always visible */
      #toggleListBtn {
        display: inline-block;
      }
      .top-bar {
        left: 0;
        right: 0;
        border-radius: 0;
      }
      /* Position list below top-bar */
      #cameraListView {
        top: 60px;
      }
      /* Full-width video on mobile */
      #cameraListAlphabetical .video-container {
        width: 100%;
        aspect-ratio: 16 / 9;
      }
    }
      .top-bar { left: 0; right: 0; border-radius: 0; }
      #cameraListView { top: 60px; }
      #cameraListAlphabetical .video-container { width: 100%; aspect-ratio: 16 / 9; }
    }
  </style>
</head>
<body>
  <div class="top-bar">
    <input id="searchBox" placeholder="–ü–æ–∏—Å–∫ –∫–∞–º–µ—Ä—ã" />
    <button class="filter-btn" data-type="food">üçî</button>
    <button class="filter-btn" data-type="parking">‚ìÇÔ∏è</button>
    <button class="filter-btn" data-type="gas">‚õΩ</button>
    <button class="filter-btn" data-type="laundry">üß∫</button>
    <button class="filter-btn" data-type="building">üè¢</button>
    <button class="filter-btn" data-type="ev">üîå</button>
    <button id="toggleMapBtn">üó∫Ô∏è</button>
    <button id="toggleListBtn">üìã</button>
  </div>
  <div id="map"></div>
  <div id="cameraListView"><ul id="cameraListAlphabetical"></ul></div>
  <div id="controls">
    <button id="zoom-in">+</button>
    <button id="zoom-out">‚àí</button>
    <button id="locateBtn">üéØ</button>
  </div>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  <script>
    // Data
    const markers = [
      { id: 'OFFICE', address: '300 North 3rd Street, Burbank, CA', url: '/hls/cam1.m3u8' },
      { id: 'BBQ', lat: 34.160185, lng: -118.254661, url: '/hls/cam2.m3u8' },
      { id: '5STAR', address: '8230 Allott Ave, Panorama City, CA 91402', url: '/hls/cam3.m3u8' },
      { id: "Trader Jo's", lat: 34.159959, lng: -118.254310, url: '/hls/cam5.m3u8' },
      { id: 'Master BBQ', lat: 34.146667, lng: -118.262778, url: '/hls/cam6.m3u8' },
      { id: 'BJ-1', lat: 34.202053, lng: -118.408861, url: '/hls/cam8.m3u8' },
      { id: 'BJ-2', lat: 34.202253, lng: -118.408661, url: '/hls/cam9.m3u8' },
      { id: 'Home', lat: 34.207930, lng: -118.369230, url: '/hls/cam10.m3u8' },
      { id: 'Meat master', lat: 34.194127, lng: -118.364687, url: '/hls/cam11.m3u8' }
    ];
    // Map init
    const map = L.map('map', { zoomControl: false });
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);
    const bounds = L.latLngBounds([]);
    const redIcon = new L.Icon({ iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png', shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png', iconSize: [25,41], iconAnchor: [12,41], popupAnchor: [1,-34], shadowSize: [41,41] });
    const markerRefs = [];
    (async()=>{
      for(const cam of markers){
        let lat=cam.lat, lng=cam.lng;
        if(lat==null||lng==null){
          const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(cam.address)}`);
          const data = await res.json(); if(!data.length) continue;
          lat=+data[0].lat; lng=+data[0].lon;
        }
        const marker = L.marker([lat,lng],{icon:redIcon}).addTo(map).bindTooltip(cam.id,{permanent:true,direction:'right'});
        bounds.extend([lat,lng]);
        markerRefs.push({id:cam.id,url:cam.url});
      }
      map.fitBounds(bounds.pad(0.2));
    })();
    // Controls
    document.getElementById('zoom-in').onclick = ()=>map.zoomIn();
    document.getElementById('zoom-out').onclick = ()=>map.zoomOut();
    document.getElementById('locateBtn').onclick = ()=>map.locate({setView:true,maxZoom:16});
    map.on('locationfound', e=>{L.marker(e.latlng,{icon:redIcon}).addTo(map).bindTooltip('–í—ã –∑–¥–µ—Å—å').openTooltip(); map.setView(e.latlng,16);});
    map.on('locationerror', ()=>{});
    document.getElementById('toggleMapBtn').onclick = ()=>{ document.getElementById('map').style.display='block'; document.getElementById('cameraListView').style.display='none'; document.getElementById('toggleMapBtn').classList.add('active'); document.getElementById('toggleListBtn').classList.remove('active'); map.invalidateSize(); };
    document.getElementById('toggleListBtn').onclick = ()=>{ buildList(); document.getElementById('map').style.display='none'; document.getElementById('cameraListView').style.display='block'; document.getElementById('toggleListBtn').classList.add('active'); document.getElementById('toggleMapBtn').classList.remove('active'); };
    // Build list
    function buildList(){
      const ul = document.getElementById('cameraListAlphabetical'); ul.innerHTML='';
      [...markerRefs].sort((a,b)=>a.id.localeCompare(b.id,{sensitivity:'base'})).forEach(cam=>{
        const li = document.createElement('li');
        const title = document.createElement('div'); title.textContent = cam.id; title.className='title';
        const vc = document.createElement('div'); vc.className='video-container';
        const video = document.createElement('video'); video.controls=true; video.playsInline=true; vc.appendChild(video);
        title.addEventListener('click', () => {
          const open = vc.style.display === 'block';
          if (open) {
            vc.style.display = 'none';
            // stop and destroy HLS instance
            if (video._hls) {
              video._hls.destroy();
              delete video._hls;
            }
            video.pause();
            video.removeAttribute('src');
            video.load();
          } else {
            vc.style.display = 'block';
            if (Hls.isSupported()) {
              const hls = new Hls({
                lowLatencyMode: true,
                liveSyncDurationCount: 3,
                maxBufferLength: 30,
                maxMaxBufferLength: 60
              });
              hls.loadSource(cam.url);
              hls.attachMedia(video);
              hls.on(Hls.Events.MANIFEST_PARSED, () => video.play());
              video._hls = hls;
            } else {
              video.src = cam.url;
              video.onloadedmetadata = () => video.play();
            }
          }
        });
        li.appendChild(title); li.appendChild(vc); ul.appendChild(li);
      });
    }
    // Search
    document.getElementById('searchBox').addEventListener('input', e=>{
      const q = e.target.value.trim().toLowerCase();
      document.querySelectorAll('#cameraListAlphabetical .title').forEach(t=>{
        t.parentElement.style.display = t.textContent.toLowerCase().includes(q)?'block':'none';
      });
    });
  </script>
</body>
</html>
