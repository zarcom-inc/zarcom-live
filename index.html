<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Zarcom Cameras Gallery</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <style>
    html, body { margin:0; padding:0; height:100%; width:100%; overflow:hidden; font-family: sans-serif; }
    header.site-header {
      position: fixed; top:0; left:0; width:100%; height:60px;
      background:#333; color:#fff; display:flex; align-items:center; padding:0 16px; z-index:2000;
      box-shadow:0 2px 4px rgba(0,0,0,0.3);
    }
    header.site-header h1 { margin:0; font-size:20px; }
    .top-bar {
      position: fixed; top:60px; left:16px; z-index:1500;
      display:flex; gap:8px;
    }
    .top-bar button {
      padding:8px; border:none; border-radius:4px;
      background:#fff; cursor:pointer; font-size:16px;
      box-shadow:0 1px 3px rgba(0,0,0,0.2);
    }
    .top-bar button.active { background:#ddd; }

    #map { display:none; position:absolute; top:60px; bottom:0; width:100%; }
    #cameraListView {
      position:absolute; top:60px; left:0; right:0; bottom:0;
      padding:16px; overflow-y:auto; background:#f0f0f0;
    }
    #cameraListView ul {
      display:grid;
      grid-template-columns: repeat(auto-fill, minmax(320px,1fr));
      gap:16px;
      list-style:none; margin:0; padding:0;
    }
    #cameraListView li {
      background:#fff; border-radius:6px; overflow:hidden;
      box-shadow:0 1px 4px rgba(0,0,0,0.1);
      display:flex; flex-direction:column;
    }
    .cam-title {
      padding:8px 12px; font-weight:bold; color:#333;
      border-bottom:1px solid #e0e0e0;
    }
    .popup-controls {
      display:flex; align-items:center; padding:8px 12px; gap:4px;
      border-bottom:1px solid #e0e0e0;
    }
    .popup-controls button, .popup-controls select {
      flex: 1; padding:6px; font-size:13px;
      border:1px solid #ccc; border-radius:3px;
      background:#fff;
      cursor:pointer;
    }
    .popup-controls button.active {
      background:#28a745; /* –∑–µ–ª—ë–Ω—ã–π */
      color:#fff;
      border-color:#28a745;
    }
    .cam-video {
      position:relative; width:100%; padding-top:56.25%; /* 16:9 */
      background:#000;
    }
    .cam-video video {
      position:absolute; top:0; left:0; width:100%; height:100%;
      object-fit:cover;
    }
  </style>
</head>
<body>
  <header class="site-header">
    <h1>Zarcom Cameras Monitoring</h1>
  </header>
  <div class="top-bar">
    <button id="toggleMapBtn">üó∫Ô∏è Map</button>
    <button id="toggleListBtn" class="active">üìã Gallery</button>
  </div>
  <div id="map"></div>
  <div id="cameraListView">
    <ul id="cameraList"></ul>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  <script>
    // –î–∞—Ç—ã –ø–æ—Å–ª–µ–¥–Ω–∏—Ö 3 –¥–Ω–µ–π
    function getLastDates(days) {
      const arr = [];
      for (let i=0; i<days; i++) {
        const d = new Date();
        d.setUTCDate(d.getUTCDate() - i);
        arr.push(d.toISOString().slice(0,10));
      }
      return arr;
    }
    // –í—Å—Ç–∞–≤–ª—è–µ–º HLS-–ø–æ—Ç–æ–∫
    function attachHls(videoEl, src) {
      if (videoEl._hls) { videoEl._hls.destroy(); delete videoEl._hls; }
      if (Hls.isSupported()) {
        const hls = new Hls();
        hls.loadSource(src);
        hls.attachMedia(videoEl);
        hls.on(Hls.Events.MANIFEST_PARSED, ()=> videoEl.play());
        videoEl._hls = hls;
      } else {
        videoEl.src = src;
        videoEl.onloadedmetadata = ()=> videoEl.play();
      }
    }

    const cameras = [
      { id:'OFFICE', lat:34.1372, lng:-118.3550, urlLive:'/hls/cam1.m3u8', urlArchive:'/hls/archive/cam1' },
      { id:'BBQ',    lat:34.1602, lng:-118.2547, urlLive:'/hls/cam2.m3u8', urlArchive:'/hls/archive/cam2' },
      { id:'5STAR',  lat:34.1212, lng:-118.4089, urlLive:'/hls/cam3.m3u8', urlArchive:'/hls/archive/cam3' },
      { id:"Trader Jo's", lat:34.15996, lng:-118.25431, urlLive:'/hls/cam5.m3u8', urlArchive:'/hls/archive/cam5' },
      { id:'Master BBQ',  lat:34.14667, lng:-118.26278, urlLive:'/hls/cam6.m3u8', urlArchive:'/hls/archive/cam6' },
      { id:'BJ-1', lat:34.20205, lng:-118.40886, urlLive:'/hls/cam8.m3u8', urlArchive:'/hls/archive/cam8' },
      { id:'BJ-2', lat:34.20225, lng:-118.40866, urlLive:'/hls/cam9.m3u8', urlArchive:'/hls/archive/cam9' },
      { id:'Home', lat:34.20793, lng:-118.36923, urlLive:'/hls/cam10.m3u8', urlArchive:'/hls/archive/cam10' },
      { id:'Meat Master', lat:34.19413, lng:-118.36469, urlLive:'/hls/cam11.m3u8', urlArchive:'/hls/archive/cam11' }
    ];

    // –°—Ç—Ä–æ–∏–º –≥–∞–ª–µ—Ä–µ—é
    function buildGallery() {
      const ul = document.getElementById('cameraList');
      ul.innerHTML = '';
      cameras.forEach(cam => {
        const li = document.createElement('li');

        const title = document.createElement('div');
        title.className = 'cam-title';
        title.textContent = cam.id;

        const controls = document.createElement('div');
        controls.className = 'popup-controls';

        const btnLive = document.createElement('button');
        btnLive.textContent = 'Live';
        const btnArch = document.createElement('button');
        btnArch.textContent = 'Archive';
        const sel = document.createElement('select');
        getLastDates(3).forEach(d => sel.append(new Option(d,d)));
        sel.style.display = 'none';

        controls.append(btnLive, btnArch, sel);

        const box = document.createElement('div');
        box.className = 'cam-video';
        const vid = document.createElement('video');
        vid.controls = true; vid.muted = true;
        box.append(vid);

        // –ª–æ–≥–∏–∫—É –∫–ª–∏–∫–∞
        function activate(btn) {
          btnLive.classList.remove('active');
          btnArch.classList.remove('active');
        }
        btnLive.onclick = () => {
          activate();
          btnLive.classList.add('active');
          sel.style.display = 'none';
          attachHls(vid, cam.urlLive);
        };
        btnArch.onclick = () => {
          activate();
          btnArch.classList.add('active');
          sel.style.display = 'inline-block';
          attachHls(vid, `${cam.urlArchive}/${sel.value}/index.m3u8`);
        };
        sel.onchange = btnArch.onclick;

        // –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é Live
        btnLive.onclick();

        li.append(title, controls, box);
        ul.append(li);
      });
    }

    // –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤–∏–¥–∞
    document.getElementById('toggleMapBtn').onclick = () => {
      document.getElementById('map').style.display = 'block';
      document.getElementById('cameraListView').style.display = 'none';
      document.getElementById('toggleMapBtn').classList.add('active');
      document.getElementById('toggleListBtn').classList.remove('active');
      map.invalidateSize();
    };
    document.getElementById('toggleListBtn').onclick = () => {
      buildGallery();
      document.getElementById('map').style.display = 'none';
      document.getElementById('cameraListView').style.display = 'block';
      document.getElementById('toggleListBtn').classList.add('active');
      document.getElementById('toggleMapBtn').classList.remove('active');
    };

    // –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Å –≥–∞–ª–µ—Ä–µ–µ–π
    buildGallery();

    // –µ—Å–ª–∏ –≤—Å—ë –∂–µ –Ω—É–∂–Ω–∞ –∫–∞—Ä—Ç–∞ ‚Äî –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º Leaflet
    const map = L.map('map').setView([34.16, -118.35], 12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{ maxZoom:19 }).addTo(map);
  </script>
</body>
</html>
