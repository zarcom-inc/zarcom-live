<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>Zarcom Cameras Monitoring</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <style>
    html, body { margin:0; padding:0; width:100%; height:100%; overflow:hidden; font-family:sans-serif; }
    header.site-header {
      position:fixed; top:0; left:0; right:0; height:60px;
      background:#333; color:#fff; display:flex; align-items:center; padding:0 16px; z-index:2000;
      box-shadow:0 2px 4px rgba(0,0,0,0.3);
    }
    header.site-header h1 { margin:0; font-size:20px; }
    .top-bar {
      position:fixed; top:60px; left:16px; display:flex; gap:8px; z-index:1500;
    }
    .top-bar button {
      padding:8px 12px; font-size:16px; border:none; border-radius:4px;
      background:#fff; cursor:pointer; box-shadow:0 1px 3px rgba(0,0,0,0.2);
    }
    .top-bar button.active { background:#ddd; }

    #map {
      position:absolute; top:60px; bottom:0; width:100%; height:calc(100% - 60px);
    }
    #cameraListView {
      display:none;
      position:absolute; top:60px; bottom:0; left:0; right:0;
      padding:16px; overflow-y:auto; background:#f0f0f0;
    }
    #cameraList {
      display:grid;
      grid-template-columns:repeat(auto-fill,minmax(320px,1fr));
      gap:16px; list-style:none; margin:0; padding:0;
    }
    #cameraList li {
      background:#fff; border-radius:6px; overflow:hidden;
      box-shadow:0 1px 4px rgba(0,0,0,0.1);
      display:flex; flex-direction:column;
    }
    .cam-title { padding:8px 12px; font-weight:bold; color:#333; }
    .popup-controls {
      display:flex; align-items:center; gap:4px; padding:8px 12px;
      border-top:1px solid #e0e0e0; border-bottom:1px solid #e0e0e0;
    }
    .popup-controls button,
    .popup-controls select {
      flex:1; padding:6px; font-size:13px;
      border:1px solid #ccc; border-radius:3px; background:#fff;
      cursor:pointer;
    }
    .popup-controls button.active {
      background:#28a745; color:#fff; border-color:#28a745;
    }
    .cam-video {
      display: none;
      position:relative; width:100%; padding-top:56.25%; background:#000;
    }
    .cam-video video {
      position:absolute; top:0; left:0; width:100%; height:100%; object-fit:cover;
    }

    /* —Å—Ç–∏–ª–∏ –¥–ª—è popup –Ω–∞ –∫–∞—Ä—Ç–µ */
    .video-popup { width:320px; }
    .video-popup .popup-title { text-align:center; font-weight:bold; margin-bottom:6px; }
    .video-popup .popup-controls { display:flex; gap:4px; margin-bottom:6px; }

    /* –ø–æ-—É–º–æ–ª—á–∞–Ω–∏—é –ø—Ä–æ–∑—Ä–∞—á–Ω—ã–π —Ñ–æ–Ω —É –≤—Å–µ—Ö popup */
    .leaflet-popup-content-wrapper, .leaflet-popup-tip {
      background:transparent; 
      box-shadow:none;
    }

    /* –ê –≤–æ—Ç —Ç–æ–ª—å–∫–æ –¥–ª—è Home: –±–µ–ª–∞—è —Ä–∞–º–∫–∞ –∏ —Ç–µ–Ω—å */
    .leaflet-popup-content-wrapper.home-popup {
      background: #fff;
      border: 1px solid #ccc;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
      border-radius: 6px;
    }
    .leaflet-popup-tip.home-popup {
      background: #fff;
    }
  </style>
</head>
<body>

  <header class="site-header">
    <h1>Zarcom Cameras Monitoring</h1>
  </header>

  <div class="top-bar">
    <button id="toggleMapBtn" class="active">üó∫Ô∏è Map</button>
    <button id="toggleListBtn">üìã Gallery</button>
  </div>

  <div id="map"></div>
  <div id="cameraListView">
    <ul id="cameraList"></ul>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  <script>
    const cameras = [
      { id:'OFFICE', lat:34.1372, lng:-118.3550, urlLive:'/hls/cam1.m3u8', urlArchive:'/hls/archive/cam1' },
      { id:'BBQ',    lat:34.1602, lng:-118.2547, urlLive:'/hls/cam2.m3u8', urlArchive:'/hls/archive/cam2' },
      { id:'5STAR',  lat:34.1212, lng:-118.4089, urlLive:'/hls/cam3.m3u8', urlArchive:'/hls/archive/cam3' },
      { id:"Trader Jo's", lat:34.15996, lng:-118.25431, urlLive:'/hls/cam5.m3u8', urlArchive:'/hls/archive/cam5' },
      { id:'Master BBQ',  lat:34.14667, lng:-118.26278, urlLive:'/hls/cam6.m3u8', urlArchive:'/hls/archive/cam6' },
      { id:'BJ-1', lat:34.20205, lng:-118.40886, urlLive:'/hls/cam8.m3u8', urlArchive:'/hls/archive/cam8' },
      { id:'BJ-2', lat:34.20225, lng:-118.40866, urlLive:'/hls/cam9.m3u8', urlArchive:'/hls/archive/cam9' },
      { id:'Home', lat:34.20793, lng:-118.36923, urlLive:'/hls/cam10.m3u8', urlArchive:'/hls/archive/cam10' },
      { id:'Meat Master', lat:34.19413, lng:-118.36469, urlLive:'/hls/cam11.m3u8', urlArchive:'/hls/archive/cam11' }
    ];

    function attachHls(videoEl, src) {
      if (videoEl._hls) { videoEl._hls.destroy(); delete videoEl._hls; }
      if (Hls.isSupported()) {
        const hls = new Hls();
        hls.loadSource(src);
        hls.attachMedia(videoEl);
        hls.on(Hls.Events.MANIFEST_PARSED, ()=>videoEl.play());
        videoEl._hls = hls;
      } else {
        videoEl.src = src;
        videoEl.onloadedmetadata = ()=>videoEl.play();
      }
    }

    function getLastDates(n) {
      return Array.from({length:n},(_,i)=>{
        const d = new Date();
        d.setUTCDate(d.getUTCDate() - i);
        return d.toISOString().slice(0,10);
      });
    }

    function createVideoPopup(cam) {
      const c = document.createElement('div');
      c.className = 'video-popup';
      const title = document.createElement('div');
      title.className = 'popup-title'; title.textContent = cam.id;
      const ctr = document.createElement('div');
      ctr.className = 'popup-controls';
      const bLive = document.createElement('button'); bLive.textContent='Live';
      const bArch = document.createElement('button'); bArch.textContent='Archive';
      const sel = document.createElement('select'); sel.style.display='none';
      getLastDates(3).forEach(d=>sel.append(new Option(d,d)));
      ctr.append(bLive,bArch,sel);
      const vid = document.createElement('video');
      vid.controls=true; vid.muted=true; vid.style.width='100%'; vid.style.height='180px';
      c.append(title,ctr,vid);

      bLive.onclick = ()=>{ sel.style.display='none'; attachHls(vid,cam.urlLive); };
      bArch.onclick = ()=>{ sel.style.display='inline-block'; attachHls(vid,`${cam.urlArchive}/${sel.value}/index.m3u8`); };
      sel.onchange = ()=>bArch.onclick();
      bLive.onclick();
      return c;
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç—ã
    const map = L.map('map',{ zoomControl:true }).setView([34.16,-118.35],12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{ maxZoom:19 }).addTo(map);
    const redIcon = new L.Icon({
      iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
      shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png',
      iconSize:[25,41], iconAnchor:[12,41], popupAnchor:[1,-34], shadowSize:[41,41]
    });

    // –î–æ–±–∞–≤–ª—è–µ–º –º–∞—Ä–∫–µ—Ä—ã –∏ popup
    cameras.forEach(cam=>{
      const marker = L.marker([cam.lat,cam.lng],{icon:redIcon})
        .addTo(map)
        .bindTooltip(cam.id,{permanent:true,direction:'right'});

      if (cam.id === 'Home') {
        // —Ç–æ–ª—å–∫–æ Home –ø–æ–ª—É—á–∞–µ—Ç –±–µ–ª—É—é —Ä–∞–º–∫—É
        marker.bindPopup(
          createVideoPopup(cam),
          { className: 'home-popup' }
        );
      } else {
        marker.bindPopup(createVideoPopup(cam));
      }
    });

    // ‚Ä¶ –æ—Å—Ç–∞–ª—å–Ω–æ–π –∫–æ–¥ –≥–∞–ª–µ—Ä–µ–∏ –∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –≤–∫–ª–∞–¥–æ–∫ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π ‚Ä¶
  </script>
</body>
</html>
